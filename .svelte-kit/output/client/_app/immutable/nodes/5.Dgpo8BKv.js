import"../chunks/DsnmJJEf.js";import"../chunks/69_IOA4Y.js";import{c as ea,o as Le}from"../chunks/DQbGakiq.js";import{h as W,i as aa,f as ta,g as h,Z as na,j as ra,H as sa,k as Oe,l as Ae,o as ve,z as ae,aj as oa,aB as ia,u as he,w as la,v as Y,az as We,O as ca,q as da,m as se,ag as Te,ai as fa,x as He,y as ua,aG as va,aH as me,ab as Pe,aI as ma,aJ as pa,as as _a,aK as ga,ay as ha,aL as ba,Q as ya,K as wa,aM as xa,aN as Sa,aO as ka,aP as Ea,aQ as Na,aR as Ca,aF as Oa,D as ne,S as Aa,aS as Ta,p as Ue,aT as Fe,aU as Je,ac as be,a as ze,I as $a,b as K,c as w,s as P,r as x,ae as le}from"../chunks/B2T3tXVa.js";import{s as ie}from"../chunks/GDD4EuxX.js";import{i as B}from"../chunks/8wx5JITo.js";import{c as je,a as R,f as H}from"../chunks/CoKYETho.js";import{e as te}from"../chunks/B2NiloYb.js";import{i as Ve}from"../chunks/DwP1phBF.js";import{a as V,s as Da}from"../chunks/CCiZo1aH.js";import{p as Ma}from"../chunks/BDuv_XbE.js";import{g as Ra}from"../chunks/DzBaKo5x.js";import{w as U,g as ke}from"../chunks/7mlN1pFv.js";import{t as G}from"../chunks/Cp12EmOU.js";import{p as Ia,b as La}from"../chunks/Ct0Nbtky.js";function Wa(e,t,a){for(var r=e.items,n=[],o=t.length,s=0;s<o;s++)ga(t[s].e,n,!0);var i=o>0&&n.length===0&&a!==null;if(i){var d=a.parentNode;ha(d),d.append(a),r.clear(),I(e,t[0].prev,t[o-1].next)}ba(n,()=>{for(var f=0;f<o;f++){var _=t[f];i||(r.delete(_.k),I(e,_.prev,_.next)),Pe(_.e,!i)}})}function Ha(e,t,a,r,n,o=null){var s=e,i={flags:t,items:new Map,first:null};W&&aa();var d=null,f=!1,_=new Map,y=na(()=>{var c=a();return ca(c)?c:c==null?[]:We(c)}),l,g;function u(){Pa(g,l,i,_,s,n,t,r,a),o!==null&&(l.length===0?d?He(d):d=he(()=>o(s)):d!==null&&ua(d,()=>{d=null}))}ta(()=>{g??=ya,l=h(y);var c=l.length;if(f&&c===0)return;f=c===0;let b=!1;if(W){var S=ra(s)===sa;S!==(c===0)&&(s=Oe(),Ae(s),ve(!1),b=!0)}if(W){for(var N=null,v,m=0;m<c;m++){if(ae.nodeType===oa&&ae.data===ia){s=ae,b=!0,ve(!1);break}var k=l[m],p=r(k,m);v=ye(ae,i,N,null,k,p,m,n,t,a),i.items.set(p,v),N=v}c>0&&Ae(Oe())}if(W)c===0&&o&&(d=he(()=>o(s)));else if(la()){var C=new Set,E=Y;for(m=0;m<c;m+=1){k=l[m],p=r(k,m);var O=i.items.get(p)??_.get(p);O?qe(O,k,m):(v=ye(null,i,null,null,k,p,m,n,t,a,!0),_.set(p,v)),C.add(p)}for(const[F,J]of i.items)C.has(F)||E.skipped_effects.add(J.e);E.add_callback(u)}else u();b&&ve(!0),h(y)}),W&&(s=ae)}function Pa(e,t,a,r,n,o,s,i,d){var f=t.length,_=a.items,y=a.first,l=y,g,u=null,c=[],b=[],S,N,v,m;for(m=0;m<f;m+=1){if(S=t[m],N=i(S,m),v=_.get(N),v===void 0){var k=r.get(N);if(k!==void 0){r.delete(N),_.set(N,k);var p=u?u.next:l;I(a,u,k),I(a,k,p),pe(k,p,n),u=k}else{var C=l?l.e.nodes_start:n;u=ye(C,a,u,u===null?a.first:u.next,S,N,m,o,s,d)}_.set(N,u),c=[],b=[],l=u.next;continue}if(qe(v,S,m),(v.e.f&me)!==0&&He(v.e),v!==l){if(g!==void 0&&g.has(v)){if(c.length<b.length){var E=b[0],O;u=E.prev;var F=c[0],J=c[c.length-1];for(O=0;O<c.length;O+=1)pe(c[O],E,n);for(O=0;O<b.length;O+=1)g.delete(b[O]);I(a,F.prev,J.next),I(a,u,F),I(a,J,E),l=E,u=J,m-=1,c=[],b=[]}else g.delete(v),pe(v,l,n),I(a,v.prev,v.next),I(a,v,u===null?a.first:u.next),I(a,u,v),u=v;continue}for(c=[],b=[];l!==null&&l.k!==N;)(l.e.f&me)===0&&(g??=new Set).add(l),b.push(l),l=l.next;if(l===null)continue;v=l}c.push(v),u=v,l=v.next}if(l!==null||g!==void 0){for(var Z=g===void 0?[]:We(g);l!==null;)(l.e.f&me)===0&&Z.push(l),l=l.next;var oe=Z.length;if(oe>0){var de=null;Wa(a,Z,de)}}e.first=a.first&&a.first.e,e.last=u&&u.e;for(var fe of r.values())Pe(fe.e);r.clear()}function qe(e,t,a,r){fa(e.v,t),e.i=a}function ye(e,t,a,r,n,o,s,i,d,f,_){var y=(d&ma)!==0,l=(d&pa)===0,g=y?l?se(n,!1,!1):Te(n):n,u=(d&va)===0?s:Te(s),c={i:u,v:g,k:o,a:null,e:null,prev:a,next:r};try{if(e===null){var b=document.createDocumentFragment();b.append(e=da())}return c.e=he(()=>i(e,g,u,f),W),c.e.prev=a&&a.e,c.e.next=r&&r.e,a===null?_||(t.first=c):(a.next=c,a.e.next=c.e),r!==null&&(r.prev=c,r.e.prev=c.e),c}finally{}}function pe(e,t,a){for(var r=e.next?e.next.e.nodes_start:a,n=t?t.e.nodes_start:a,o=e.e.nodes_start;o!==null&&o!==r;){var s=_a(o);n.before(o),o=s}}function I(e,t,a){t===null?e.first=a:(t.next=a,t.e.next=a&&a.e),a!==null&&(a.prev=t,a.e.prev=t&&t.e)}const Ua=Symbol("is custom element"),Fa=Symbol("is html");function Ja(e){if(W){var t=!1,a=()=>{if(!t){if(t=!0,e.hasAttribute("value")){var r=e.value;we(e,"value",null),e.value=r}if(e.hasAttribute("checked")){var n=e.checked;we(e,"checked",null),e.checked=n}}};e.__on_r=a,wa(a),xa()}}function we(e,t,a,r){var n=za(e);W&&(n[t]=e.getAttribute(t),t==="src"||t==="srcset"||t==="href"&&e.nodeName==="LINK")||n[t]!==(n[t]=a)&&(t==="loading"&&(e[Ea]=a),a==null?e.removeAttribute(t):typeof a!="string"&&ja(e).includes(t)?e[t]=a:e.setAttribute(t,a))}function za(e){return e.__attributes??={[Ua]:e.nodeName.includes("-"),[Fa]:e.namespaceURI===Sa}}var $e=new Map;function ja(e){var t=e.getAttribute("is")||e.nodeName,a=$e.get(t);if(a)return a;$e.set(t,a=[]);for(var r,n=e,o=Element.prototype;o!==n;){r=Na(n);for(var s in r)r[s].set&&a.push(s);n=ka(n)}return a}function Va(e,t,a=t){var r=new WeakSet;Ca(e,"input",async n=>{var o=n?e.defaultValue:e.value;if(o=_e(e)?ge(o):o,a(o),Y!==null&&r.add(Y),await Oa(),o!==(o=t())){var s=e.selectionStart,i=e.selectionEnd,d=e.value.length;if(e.value=o??"",i!==null){var f=e.value.length;s===i&&i===d&&f>d?(e.selectionStart=f,e.selectionEnd=f):(e.selectionStart=s,e.selectionEnd=Math.min(i,f))}}}),(W&&e.defaultValue!==e.value||ne(t)==null&&e.value)&&(a(_e(e)?ge(e.value):e.value),Y!==null&&r.add(Y)),Aa(()=>{var n=t();if(e===document.activeElement){var o=Ta??Y;if(r.has(o))return}_e(e)&&n===ge(e.value)||e.type==="date"&&!n&&!e.value||n!==e.value&&(e.value=n??"")})}function _e(e){var t=e.type;return t==="number"||t==="range"}function ge(e){return e===""?null:+e}function qa(e){return function(...t){var a=t[0];return a.preventDefault(),e?.apply(this,t)}}const Q=U([]),Ye=U(null),Be=U(null),X=U(!1),Ee=U([]);let T=null;const D=new Map,Ya={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};function Ba(){return typeof window>"u"?"":`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`}function ce(e,t){T&&T.readyState===WebSocket.OPEN&&T.send(JSON.stringify({type:e,payload:t}))}function Ke(e){const t=D.get(e);t&&(t.pc.close(),t.remoteStream&&Ee.update(a=>a.filter(r=>r.id!==t.remoteStream.id)),D.delete(e)),Q.update(a=>a.filter(r=>r.id!==e)),D.size===0&&X.set(!1)}function De(e,t,a,r){if(D.has(e))return D.get(e).pc;const n=new RTCPeerConnection(Ya);D.set(e,{id:e,nickname:t,pc:n,instrument:a}),n.onicecandidate=s=>{s.candidate&&T&&ce("signal",{to:e,signal:{type:"candidate",candidate:s.candidate}})},n.ontrack=s=>{const i=D.get(e);i&&(i.remoteStream=s.streams[0],Ee.update(d=>[...d.filter(f=>f.id!==s.streams[0].id),s.streams[0]]))},n.oniceconnectionstatechange=()=>{["failed","disconnected","closed"].includes(n.iceConnectionState)&&Ke(e)};const o=s=>{s.onopen=()=>X.set(!0),s.onclose=()=>{Array.from(D.values()).every(d=>!d.dataChannel||d.dataChannel.readyState!=="open")&&X.set(!1)},s.onmessage=d=>{try{const f=JSON.parse(d.data);switch(f.type){case"noteOn":G.noteOn(f.instrument,f.note);break;case"noteOff":G.noteOff(f.instrument,f.note);break;case"instrumentChange":Q.update(_=>_.map(y=>y.id===e?{...y,instrument:f.instrument}:y));break}}catch(f){console.error("Error handling data channel message",f)}};const i=D.get(e);i&&(i.dataChannel=s)};if(r){const s=n.createDataChannel("data");o(s)}else n.ondatachannel=s=>o(s.channel);return n}async function Ka(e){try{const t=JSON.parse(e.data),{type:a,payload:r}=t;switch(a){case"room-full":{alert("このルームは満員です。"),window.location.href="/rooms";break}case"join-success":{const{id:n,users:o}=r;Ye.set(n),Q.set(o),o.length===0&&X.set(!0),o.forEach(s=>{const i=De(s.id,s.nickname,s.instrument,!0);i.createOffer().then(d=>i.setLocalDescription(d)).then(()=>ce("signal",{to:s.id,signal:i.localDescription}))});break}case"user-joined":{const n=r;Q.update(o=>[...o,n]);break}case"signal":{const{from:n,fromNickname:o,signal:s}=r;let i=D.get(n)?.pc;if(s.type==="offer"){i||(i=De(n,o,"piano",!1)),await i.setRemoteDescription(new RTCSessionDescription(s));const d=await i.createAnswer();await i.setLocalDescription(d),ce("signal",{to:n,signal:i.localDescription})}else if(s.type==="answer")i&&await i.setRemoteDescription(new RTCSessionDescription(s));else if(s.type==="candidate"&&i&&i.remoteDescription){const d=s;await i.addIceCandidate(new RTCIceCandidate(d.candidate))}break}case"user-left":{Ke(r.id);break}}}catch(t){console.error("Failed to handle WebSocket message:",t)}}function Me(e,t){T&&T.readyState===WebSocket.OPEN||(Be.set(t),T=new WebSocket(Ba()),T.onopen=()=>ce("join-room",{roomId:e,nickname:t}),T.onmessage=Ka,T.onerror=a=>console.error("WebSocket Error:",a),T.onclose=()=>{T=null,D.forEach(a=>a.pc.close()),D.clear(),Q.set([]),Ye.set(null),X.set(!1),Ee.set([])})}function Ge(e){D.forEach(t=>{if(t.dataChannel&&t.dataChannel.readyState==="open")try{t.dataChannel.send(JSON.stringify(e))}catch(a){console.error(`Failed to send message to ${t.id}:`,a)}})}function Ga(){T&&T.close()}const xe=U(!1),Se=U(!1),re=U("piano");async function Qa(){if(!ke(xe))try{Se.set(!0),await G.init(),xe.set(!0),await G.loadAllInstruments()}catch(e){console.error("Failed to initialize or load instruments:",e),alert("オーディオまたは楽器の初期化に失敗しました。")}finally{Se.set(!1)}}function Re(e,t){const a=ke(re);G.noteOn(a,e),t&&Ge({type:"noteOn",note:e,instrument:a})}function Ie(e,t){const a=ke(re);G.noteOff(a,e),t&&Ge({type:"noteOff",note:e,instrument:a})}var Xa=H('<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full shadow-xl border border-gray-700"><h2 class="text-2xl font-bold mb-4 text-white">ニックネームを入力</h2> <form><input type="text" placeholder="ニックネーム (必須)" class="w-full px-4 py-2 mb-4 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" required/> <div class="flex justify-end"><button type="submit" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-md transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">決定</button></div></form></div></div>');function Za(e,t){Ue(t,!1);let a=Ia(t,"isOpen",8),r=se(""),n=se();const o=ea();function s(){h(r).trim()&&o("confirm",h(r).trim())}Le(()=>{typeof window<"u"&&K(r,localStorage.getItem("nickname")||"")}),Fe(()=>($a(a()),h(n)),()=>{a()&&h(n)&&setTimeout(()=>{h(n).focus()},100)}),Je(),Ve();var i=je(),d=be(i);{var f=_=>{var y=Xa(),l=w(y),g=P(w(l),2),u=w(g);Ja(u),we(u,"maxlength",15),La(u,S=>K(n,S),()=>h(n));var c=P(u,2),b=w(c);x(c),x(g),x(l),x(y),le(S=>b.disabled=S,[()=>(h(r),ne(()=>!h(r).trim()))]),Va(u,()=>h(r),S=>K(r,S)),te("submit",g,qa(s)),R(_,y)};B(d,_=>{a()&&_(f)})}R(e,i),ze()}var et=H('<div class="bg-gray-800 p-3 rounded-lg border border-cyan-500"><p class="font-bold text-white"> </p> <p class="text-xs text-gray-400"> </p></div>'),at=H('<div class="bg-gray-800 p-3 rounded-lg border border-gray-700"><p class="font-bold text-gray-300"> </p> <p class="text-xs text-gray-400"> </p></div>'),tt=H('<div class="text-center text-white">全楽器をロード中...</div>'),nt=H('<div class="text-center text-white animate-pulse">ニックネームを入力してください...</div>'),rt=H('<div class="text-center text-yellow-400 animate-pulse mb-2">他の参加者に接続中...</div>'),st=H('<div><!> <div class="flex items-center justify-center md:justify-between mb-4 flex-wrap gap-4"><div class="text-gray-500">(楽器セレクター)</div> <div class="flex items-center gap-4"><div class="text-gray-500">(マイク)</div> <div class="text-gray-500">(録音)</div></div></div> <div class="w-full h-40 rounded flex items-center justify-center"><button class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded text-white font-bold disabled:opacity-50">Piano C2 (押している間送信)</button></div></div>'),ot=H('<div class="flex flex-col h-full"><div class="mb-4 p-2"><div class="flex justify-center items-center gap-4 flex-wrap"><!> <!></div></div> <div class="flex-grow flex flex-col justify-end p-4 bg-gray-800 rounded-t-lg"><!></div></div>'),it=H("<!> <!>",1);function St(e,t){Ue(t,!1);const a=()=>V(Ma,"$page",f),r=()=>V(xe,"$isAudioReady",f),n=()=>V(X,"$isConnected",f),o=()=>V(re,"$selectedInstrument",f),s=()=>V(Be,"$localNickname",f),i=()=>V(Q,"$participants",f),d=()=>V(Se,"$isLoading",f),[f,_]=Da(),y=a().params.roomId;let l=se(null),g=se(!0);Le(()=>(window.debugNoteOn=p=>{let C="piano";re.subscribe(E=>C=E)(),console.log(`Debug: ${C} - ${p} ON`),Re(p,!1)},window.debugNoteOff=p=>{let C="piano";re.subscribe(E=>C=E)(),console.log(`Debug: ${C} - ${p} OFF`),Ie(p,!1)},K(l,localStorage.getItem("nickname")),()=>{Ga()}));async function u(p){K(l,p.detail),typeof window<"u"&&localStorage.setItem("nickname",h(l)),K(g,!1),await Qa()}const c="C2";function b(){if(!r()||!n()){console.warn("Audio not ready or not connected via WebRTC.");return}console.log(`Sending noteOn: ${c} with ${o()}`),Re(c,!0)}function S(){if(!r()||!n()){console.warn("Audio not ready or not connected via WebRTC.");return}console.log(`Sending noteOff: ${c} with ${o()}`),Ie(c,!0)}Fe(()=>(r(),h(l),Me),()=>{r()&&h(l)&&y&&Me(y,h(l))}),Je(),Ve();var N=it(),v=be(N);Za(v,{get isOpen(){return h(g)},$$events:{close:()=>Ra("/rooms"),confirm:u}});var m=P(v,2);{var k=p=>{var C=ot(),E=w(C),O=w(E),F=w(O);{var J=A=>{var $=et(),L=w($),z=w(L);x(L);var q=P(L,2),M=w(q,!0);x(q),x($),le(()=>{ie(z,`${s()??""} (You)`),ie(M,o())}),R(A,$)};B(F,A=>{s()&&A(J)})}var Z=P(F,2);Ha(Z,1,i,A=>A.id,(A,$)=>{var L=at(),z=w(L),q=w(z,!0);x(z);var M=P(z,2),j=w(M,!0);x(M),x(L),le(()=>{ie(q,(h($),ne(()=>h($).nickname))),ie(j,(h($),ne(()=>h($).instrument)))}),R(A,L)}),x(O),x(E);var oe=P(E,2),de=w(oe);{var fe=A=>{var $=tt();R(A,$)},Qe=A=>{var $=je(),L=be($);{var z=M=>{var j=nt();R(M,j)},q=M=>{var j=st(),Ne=w(j);{var Xe=ue=>{var Ze=rt();R(ue,Ze)};B(Ne,ue=>{n(),i(),ne(()=>!n()&&i().length>0)&&ue(Xe)})}var Ce=P(Ne,4),ee=w(Ce);x(Ce),x(j),le(()=>ee.disabled=!n()||!r()),te("mousedown",ee,b),te("mouseup",ee,S),te("touchstart",ee,b),te("touchend",ee,S),R(M,j)};B(L,M=>{r()?M(q,!1):M(z)},!0)}R(A,$)};B(de,A=>{d()?A(fe):A(Qe,!1)})}x(oe),x(C),R(p,C)};B(m,p=>{h(g)||p(k)})}R(e,N),ze(),_()}export{St as component};
